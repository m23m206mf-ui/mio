<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>岡山・キャンパス内中古品取引プラットフォーム</title>
  <meta name="description" content="学内限定の中古教材・参考書の循環プラットフォーム（ローカル保存・オフライン可）">
  <style>
    :root{
      --bg:#fafafa;--card:#ffffff;--ink:#1f2937;--muted:#6b7280;--primary:#16a34a;
      --accent:#22c55e;--border:#e5e7eb;--danger:#ef4444;--warning:#f59e0b;--info:#3b82f6
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Hiragino Kaku Gothic ProN","Noto Sans JP","Yu Gothic",sans-serif;color:var(--ink);background:var(--bg)}
    a{color:#0ea5e9;text-decoration:none}a:hover{text-decoration:underline}
    header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,#ffffff,rgba(255,255,255,.9));backdrop-filter:saturate(160%) blur(6px);border-bottom:1px solid var(--border)}
    .wrap{max-width:1180px;margin:auto;padding:16px}
    h1{margin:0;font-size:clamp(20px,3vw,28px)}
    .sub{color:var(--muted);font-size:13px}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px;align-items:center}
    .spacer{flex:1 1 auto}
    input,select,button,textarea{font:inherit}
    .input{border:1px solid var(--border);border-radius:10px;padding:10px;background:#fff;min-width:180px}
    .btn{border:none;border-radius:999px;padding:10px 14px;cursor:pointer;font-weight:600}
    .btn.primary{background:var(--primary);color:#fff}
    .btn.ghost{background:#fff;border:1px solid var(--border)}
    .btn.warn{background:var(--warning);color:#111}
    .btn.info{background:var(--info);color:#fff}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:14px;margin-top:16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:18px;overflow:hidden;display:flex;flex-direction:column}
    .thumb{aspect-ratio:4/3;background:#f3f4f6;display:grid;place-items:center}
    .thumb img{width:100%;height:100%;object-fit:cover}
    .body{padding:12px 14px;display:flex;flex-direction:column;gap:6px}
    .title{font-weight:700}
    .muted{color:var(--muted);font-size:12px}
    .price{font-weight:800;color:var(--primary)}
    .price del{color:#9ca3af;font-weight:600;margin-left:6px}
    .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
    .badge{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);padding:4px 8px;border-radius:999px;font-size:12px;color:var(--muted)}
    .sold{background:#fef2f2;border-color:#fecaca;color:#b91c1c}
    dialog{border:none;border-radius:16px;width:min(900px,96vw);padding:0;overflow:hidden}
    dialog::backdrop{background:rgba(0,0,0,.35)}
    .modal-head{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;background:#fff}
    .modal-body{padding:16px;background:#fff;max-height:70vh;overflow:auto}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row-1{grid-template-columns:1fr}
    .footer{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-top:1px solid var(--border);background:#fff}
    .note{font-size:12px;color:var(--muted)}
    .empty{border:2px dashed var(--border);border-radius:16px;padding:28px;text-align:center;color:var(--muted);margin-top:18px}
    .help{font-size:12px;color:var(--muted);margin-top:6px}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;background:#f3f4f6;font-size:12px;color:#374151}
    .footlinks{display:flex;gap:12px;justify-content:center;align-items:center;margin-top:6px}
    .section{margin-top:16px;padding:12px;border:1px dashed var(--border);border-radius:12px;background:#fff}
    .kpi{display:flex;gap:8px;flex-wrap:wrap}
    .kpi .pill{background:#eef2ff}
    @media (max-width:640px){.row{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>岡山・キャンパス内中古品取引プラットフォーム</h1>
      <div class="sub">教材・参考書の循環プラットフォーム（学内限定／ローカル保存／オフライン可）</div>
      <div class="toolbar">
        <input id="q" class="input" placeholder="書名・著者を検索" />
        <select id="cat" class="input">
          <option value="">カテゴリ（すべて）</option>
          <option>教科書</option><option>専門書</option><option>参考書</option><option>語学</option><option>小説</option>
        </select>
        <select id="cond" class="input">
          <option value="">状態（すべて）</option>
          <option>新品同様</option><option>良い</option><option>可</option>
        </select>
        <select id="pickup" class="input">
          <option value="">受け渡し場所（すべて）</option>
        </select>
        <select id="sort" class="input">
          <option value="new">新着順</option>
          <option value="price_asc">価格が安い順</option>
          <option value="price_desc">価格が高い順</option>
        </select>
        <button id="addBtn" class="btn primary">＋ 出品する</button>
        <button id="couponBtn" class="btn ghost" title="クーポンを適用/管理">クーポン</button>
        <button id="exportBtn" class="btn ghost">データを書き出す</button>
        <label class="btn ghost" for="importFile">読み込み</label>
        <input id="importFile" type="file" accept="application/json" style="display:none"/>
        <button id="buybackBtn" class="btn warn" title="参考買取価格を検索">買取価格を検索</button>
        <span class="spacer"></span>
        <button id="bizBtn" class="btn info" title="事業者・法令情報">事業者設定</button>
        <a href="javascript:void(0)" id="openTos">利用規約</a>
      </div>
      <div class="kpi" id="kpi"></div>
    </div>
  </header>

  <main class="wrap">
    <div id="stats" class="muted"></div>
    <div id="list" class="grid"></div>
    <div id="empty" class="empty" hidden>まだ出品がありません。「＋ 出品する」から追加してください。</div>
  </main>

  <!-- 出品モーダル -->
  <dialog id="modal">
    <form method="dialog">
      <div class="modal-head">
        <strong id="modalTitle">出品を作成</strong>
        <button class="btn ghost" value="close">閉じる</button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div>
            <label>書名<br><input id="f_title" class="input" required></label>
          </div>
          <div>
            <label>著者<br><input id="f_author" class="input"></label>
          </div>
        </div>
        <div class="row">
          <div>
            <label>カテゴリ<br>
              <select id="f_cat" class="input" required>
                <option>教科書</option><option>専門書</option><option>参考書</option><option>語学</option><option>小説</option>
              </select>
            </label>
          </div>
          <div>
            <label>状態<br>
              <select id="f_cond" class="input" required>
                <option>新品同様</option><option selected>良い</option><option>可</option>
              </select>
            </label>
          </div>
        </div>
        <div class="row">
          <div>
            <label>価格（円）<br>
              <div style="display:flex; gap:8px; align-items:center;">
                <input id="f_price" type="number" min="0" step="1" class="input" required>
                <button id="suggestBtn" type="button" class="btn ghost" title="相場から自動計算">価格を提案</button>
              </div>
              <div id="suggestInfo" class="help"></div>
            </label>
          </div>
          <div>
            <label>画像URL（任意）<br>
              <div style="display:flex; gap:8px; align-items:center;">
                <input id="f_img" class="input" placeholder="https://...">
                <button id="genCoverBtn" type="button" class="btn ghost" title="タイトルから生成">画像を自動生成</button>
              </div>
              <div class="help">※ URL を貼るか、「画像を自動生成」でカバー画像（SVG）を作成します</div>
            </label>
          </div>
        </div>
        <!-- 支払情報 -->
        <div class="row">
          <div>
            <label>支払方法<br>
              <select id="f_payMethod" class="input">
                <option value="">未指定</option>
                <option>対面現金</option>
                <option>PayPay</option>
                <option>銀行振込</option>
              </select>
            </label>
          </div>
          <div>
            <label>決済リンク（任意）<br>
              <input id="f_payLink" class="input" placeholder="例：https://paypayリンク や 振込案内ページ">
            </label>
          </div>
        </div>
        <div class="row">
          <div>
            <label>受け渡し場所<br><input id="f_pickup" class="input" placeholder="例：図書館前"></label>
          </div>
          <div>
            <label>クーポンコード（任意）<br><input id="f_coupon" class="input" placeholder="例：WELCOME10"></label>
          </div>
        </div>
        <div class="row">
          <div>
            <label>出品者名（ニックネーム可）<br><input id="f_seller" class="input"></label>
          </div>
          <div>
            <label>連絡先（メール / SNS / 学内ID）<br><input id="f_contact" class="input"></label>
          </div>
        </div>
        <div class="row row-1">
          <label>説明（任意）<br><textarea id="f_desc" class="input" rows="4" placeholder="書き込み有無、版、受け渡し時間帯など"></textarea></label>
        </div>
        <div class="help">※ 保存先：この端末のローカルストレージ</div>
      </div>
      <div class="footer">
        <div style="display:flex;gap:8px">
          <button id="delBtn" class="btn" style="display:none;background:var(--danger);color:#fff">削除</button>
          <button class="btn primary" id="saveBtn">保存</button>
        </div>
        <button class="btn ghost" value="close">閉じる</button>
      </div>
    </form>
  </dialog>

  <!-- クーポン管理 -->
  <dialog id="coupon">
    <form method="dialog">
      <div class="modal-head">
        <strong>クーポンを適用／管理</strong>
        <button class="btn ghost" value="close">閉じる</button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div>
            <label>コード<br><input id="cp_code" class="input" placeholder="WELCOME10"></label>
          </div>
          <div>
            <label>値引タイプ<br>
              <select id="cp_type" class="input">
                <option value="pct">割合（%OFF）</option>
                <option value="amt">金額（円OFF）</option>
              </select>
            </label>
          </div>
        </div>
        <div class="row">
          <div>
            <label>値引値（%または円）<br><input id="cp_value" class="input" type="number" min="1" step="1" placeholder="10"></label>
          </div>
          <div>
            <label>最小注文金額（任意）<br><input id="cp_min" class="input" type="number" min="0" step="1" placeholder="0"></label>
          </div>
        </div>
        <div class="row">
          <div>
            <label>適用カテゴリ（空で全体）<br><input id="cp_cat" class="input" placeholder="教科書,語学"></label>
          </div>
          <div>
            <label>有効期限（任意）<br><input id="cp_until" class="input" type="date"></label>
          </div>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:6px">
          <button id="cp_add" class="btn primary" type="button">追加/更新</button>
          <button id="cp_clear" class="btn ghost" type="button">全クーポン削除</button>
        </div>
        <div id="cp_list" class="help" style="margin-top:10px"></div>
        <div class="help">※ PPTで触れられている「クーポン導入」構想を反映。AI価格推奨と併用可。</div>
      </div>
      <div class="footer">
        <span class="note">ローカル保存／オフライン可</span>
        <button class="btn ghost" value="close">閉じる</button>
      </div>
    </form>
  </dialog>

  <!-- 参考買取価格検索 -->
  <dialog id="buyback">
    <form method="dialog">
      <div class="modal-head">
        <strong>参考買取価格（目安）を検索</strong>
        <button class="btn ghost" value="close">閉じる</button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div>
            <label>キーワード（書名 / 著者 / ISBN）<br>
              <input id="bb_query" class="input" placeholder="例：Python 実践 / 978...">
            </label>
          </div>
          <div>
            <label>状態<br>
              <select id="bb_cond" class="input">
                <option selected>良い</option>
                <option>新品同様</option>
                <option>可</option>
              </select>
            </label>
          </div>
        </div>
        <div class="row row-1">
          <div>
            <button id="bb_calc" class="btn primary" type="button">買取価格を計算</button>
            <label class="btn ghost" for="buybackFile" title="参考定価データ(JSON)を読み込み">参考データ読み込み</label>
            <input id="buybackFile" type="file" accept="application/json" style="display:none">
          </div>
        </div>
        <div id="bb_result" class="help" style="margin-top:10px"></div>
        <div class="help">※ 計算方法：掲載中央値 or 参考定価 × 状態係数。保証値ではありません。</div>
      </div>
      <div class="footer">
        <span class="note">ローカルで計算（オフライン可）</span>
        <button class="btn ghost" value="close">閉じる</button>
      </div>
    </form>
  </dialog>

  <!-- 利用規約（保持） -->
  <dialog id="tos">
    <form method="dialog">
      <div class="modal-head">
        <strong>利用規約（学内・非営利の雛形）</strong>
        <button class="btn ghost" value="close">閉じる</button>
      </div>
      <div class="modal-body">
        <ol style="padding-left:18px;line-height:1.7">
          <li>本サイトは学内限定の試験運用プロトタイプであり、商用利用を禁止します。</li>
          <li>データは端末のローカルストレージに保存されます。削除・端末変更で失われる場合があります。</li>
          <li>出品は真実・正確を心掛け、権利侵害・違法物品の掲載は禁止します。</li>
          <li>価格提案・買取目安は参考値で、実価格の保証ではありません。</li>
          <li>取引は当事者の自己責任とし、運営は一切の責任を負いません（故意・重過失を除く）。</li>
          <li>必要に応じて特定商取引法表示・古物商許可が必要となる可能性があります（事業者設定をご確認ください）。</li>
        </ol>
        <div style="margin-top:8px">
          <label style="display:flex;align-items:center;gap:8px">
            <input type="checkbox" id="tosAgreeChk"> 本規約に同意します（次回以降は表示しない）
          </label>
        </div>
      </div>
      <div class="footer">
        <span class="note">学内参考用のプロトタイプ</span>
        <div style="display:flex;gap:8px">
          <button class="btn ghost" value="close">閉じる</button>
          <button id="tosAgreeBtn" class="btn primary" value="ok">同意して閉じる</button>
        </div>
      </div>
    </form>
  </dialog>

  <!-- 事業者・法令情報（特商法表示・古物商許可No.など） -->
  <dialog id="biz">
    <form method="dialog">
      <div class="modal-head">
        <strong>事業者・法令情報</strong>
        <button class="btn ghost" value="close">閉じる</button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div><label>事業者名（団体/サークル名可）<br><input id="bz_name" class="input" placeholder="Campus Reuse Books Project"></label></div>
          <div><label>代表者名<br><input id="bz_owner" class="input" placeholder="山田 太郎"></label></div>
        </div>
        <div class="row">
          <div><label>所在地（学内住所可）<br><input id="bz_addr" class="input" placeholder="〒700-0000 岡山市..."></label></div>
          <div><label>連絡先（メール/電話）<br><input id="bz_contact" class="input" placeholder="example@univ.jp / 090-xxxx-xxxx"></label></div>
        </div>
        <div class="row">
          <div><label>ウェブURL（任意）<br><input id="bz_url" class="input" placeholder="https://..."></label></div>
          <div><label>古物商許可番号（任意）<br><input id="bz_kobutsu" class="input" placeholder="岡山県公安委員会 第XXXX号"></label></div>
        </div>
        <div class="row row-1">
          <label>特定商取引法に基づく表記（自動生成プレビュー）</label>
          <div id="tokusho" class="section" style="font-size:13px;line-height:1.7"></div>
        </div>
      </div>
      <div class="footer">
        <div style="display:flex;gap:8px">
          <button id="bz_save" class="btn primary">保存</button>
          <button id="bz_clear" class="btn ghost">消去</button>
        </div>
        <button class="btn ghost" value="close">閉じる</button>
      </div>
    </form>
  </dialog>

  <!-- フッター -->
  <footer style="padding:20px;text-align:center;font-size:12px;color:#6b7280;border-top:1px solid #e5e7eb;background:#f9fafb;">
    <p><strong>免責事項（Disclaimer）</strong></p>
    <p>
      本サイトは学内限定の教材・書籍の再利用を目的としています。取引は自己責任で行ってください。
      運営は、掲載内容・取引の安全性・トラブルに関して一切の責任を負いません。
    </p>
    <div class="footlinks">
      <a href="javascript:void(0)" id="openTos2">利用規約</a>
      <span>・</span>
      <a href="javascript:void(0)" id="openBiz">特定商取引法の表示</a>
      <span>・</span>
      <a href="#top">ページ上部へ</a>
    </div>
    <p style="margin-top:8px;">© 2025 Campus Reuse Books Project</p>
  </footer>

  <script>
    const $ = (s,el=document)=>el.querySelector(s);
    const $$ = (s,el=document)=>Array.from(el.querySelectorAll(s));
    const storeKey = 'crb.books.real.v1';
    const couponKey = 'crb.coupons.v1';
    const tosKey = 'crb.tos.agreed.v2';
    const pickupKey = 'crb.pickups.v1';
    const bizKey = 'crb.biz.v1';
    const buybackIndexKey = 'crb.buybackIndex.v1';
    let books = [], coupons=[], pickups=[], biz={}, buybackIndex=[];
    let editingId = null;

    function uid(){return Math.random().toString(36).slice(2)+Date.now().toString(36)}
    function fmtJPY(n){ return new Intl.NumberFormat('ja-JP').format(Math.round(n||0)) }
    function avg(arr){ return arr.reduce((s,n)=>s+n,0) / (arr.length||1) }
    function median(arr){ if(arr.length===0) return 0; const a = arr.slice().sort((x,y)=>x-y); const m = Math.floor(a.length/2); return a.length%2 ? a[m] : (a[m-1]+a[m])/2; }
    function hashCode(str){ let h=0; for(let i=0;i<str.length;i++){ h = (h<<5)-h + str.charCodeAt(i); h|=0 } return Math.abs(h) }
    function coverFromTitle(title='BOOK', author=''){
      const seed = hashCode(title+author);
      const hue = seed % 360, hue2 = (hue+40)%360;
      const esc = s=>s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
      const svg = `
        <svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1200 900'>
          <defs><linearGradient id='g' x1='0' y1='0' x2='1' y2='1'>
            <stop offset='0%' stop-color='hsl(${hue},60%,60%)'/>
            <stop offset='100%' stop-color='hsl(${hue2},60%,50%)'/>
          </linearGradient></defs>
          <rect width='1200' height='900' fill='url(#g)'/>
          <rect x='80' y='80' width='1040' height='740' rx='28' ry='28' fill='rgba(255,255,255,0.22)'/>
          <text x='100' y='360' font-family='Hiragino Kaku Gothic ProN, Noto Sans JP, sans-serif' font-weight='800' font-size='96' fill='white'>${esc(title).slice(0,18)}</text>
          <text x='100' y='450' font-family='Hiragino Kaku Gothic ProN, Noto Sans JP, sans-serif' font-weight='700' font-size='52' fill='rgba(255,255,255,0.9)'>${esc(author||'').slice(0,22)}</text>
          <text x='100' y='540' font-family='Menlo, monospace' font-size='28' fill='rgba(255,255,255,0.85)'>Campus Reuse Books</text>
        </svg>`;
      return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
    }

    const condFactorBuyback = { '新品同様': 0.60, '良い': 0.45, '可': 0.25 };
    const condFactorList = { '新品同様': 0.78, '良い': 0.62, '可': 0.42 };
    function findListingMatches(query){
      const q = (query||'').trim().toLowerCase(); if(!q) return [];
      return books.filter(b => [b.title, b.author].join('\n').toLowerCase().includes(q));
    }
    function baseFromListingOrMSRP(query){
      const matches = findListingMatches(query);
      if(matches.length){ return { base: median(matches.map(m=>m.price)), count: matches.length, source: 'listing_median' }; }
      const q = (query||'').trim().toLowerCase();
      const hit = buybackIndex.find(x => x.keyword && q.includes(String(x.keyword).toLowerCase()) );
      if(hit) return { base: hit.msrp, count: 0, source: 'msrp' };
      return null;
    }
    function estimateBuyback(base, condition){
      const k = condFactorBuyback[condition] ?? condFactorBuyback['良い'];
      const mid = base * k; return { mid, low: mid*0.85, high: mid*1.15 };
    }
    function recommendListPrice(query, condition){
      const base = baseFromListingOrMSRP(query); if(!base) return null;
      const listK = condFactorList[condition] ?? condFactorList['良い'];
      const buyback = estimateBuyback(base.base, condition).mid;
      let rec = base.base * listK; const floor = buyback * 1.10; if(rec < floor) rec = Math.max(rec, floor);
      return { source: base.source, base: base.base, count: base.count, rec: rec, range: { low: rec*0.9, high: rec*1.1 }, buybackMid: buyback };
    }

    // coupons
    const couponKeyLS = couponKey;
    function loadCoupons(){ try{ coupons = JSON.parse(localStorage.getItem(couponKeyLS) || '[]') }catch{ coupons=[] } }
    function saveCoupons(){ localStorage.setItem(couponKeyLS, JSON.stringify(coupons)) }
    function applyCoupon(code, price, category){
      code = (code||'').trim(); if(!code) return {price, applied:null};
      const now = new Date().toISOString().slice(0,10);
      const c = coupons.find(x=>x.code===code);
      if(!c) return {price, applied:null};
      if(c.until && c.until < now) return {price, applied:null};
      if(c.min && price < c.min) return {price, applied:null};
      if(c.cat && c.cat.length){
        if(!c.cat.includes(category)) return {price, applied:null};
      }
      let newPrice = price;
      if(c.type==='pct') newPrice = Math.max(0, Math.round(price*(100 - c.value)/100));
      else newPrice = Math.max(0, price - c.value);
      return {price:newPrice, applied:c};
    }

    // pickups / biz
    function loadBiz(){ try{ biz = JSON.parse(localStorage.getItem(bizKey) || '{}') }catch{ biz={} } }
    function saveBiz(){ localStorage.setItem(bizKey, JSON.stringify(biz)) }
    function renderTokusho(){
      const {name, owner, addr, contact, url, kobutsu} = biz;
      $('#tokusho').innerHTML = `
        <div><strong>販売業者</strong>：${name||'-'}</div>
        <div><strong>運営責任者</strong>：${owner||'-'}</div>
        <div><strong>所在地</strong>：${addr||'-'}</div>
        <div><strong>連絡先</strong>：${contact||'-'}</div>
        <div><strong>URL</strong>：${url||'-'}</div>
        <div><strong>古物商許可番号</strong>：${kobutsu||'（必要に応じて申請）'}</div>
        <div><strong>販売価格</strong>：各商品ページに税込価格を表示</div>
        <div><strong>商品代金以外の必要料金</strong>：対面引渡し原則／配送時の送料は実費</div>
        <div><strong>代金の支払方法・時期</strong>：現金・キャッシュレス等、受け渡し時に支払い</div>
        <div><strong>引渡時期</strong>：合意日時に受け渡し</div>
        <div><strong>返品・キャンセル</strong>：原則不可。ただし合意により7日以内の返品可（状態相違等）</div>
      `;
    }
    function loadPickups(){ try{ pickups = JSON.parse(localStorage.getItem(pickupKey) || '[]') }catch{ pickups=[] } }
    function savePickups(){ localStorage.setItem(pickupKey, JSON.stringify(pickups)) }
    function ensurePickupOptions(){
      const sel = $('#pickup'); const olds = new Set(Array.from(sel.options).map(o=>o.value));
      pickups.forEach(p=>{ if(!olds.has(p)){ const opt = document.createElement('option'); opt.value=p; opt.textContent=p; sel.appendChild(opt); } });
    }

    // data IO
    function load(){
      try{ books = JSON.parse(localStorage.getItem(storeKey) || '[]') }catch{ books=[] }
      
      if(!books || books.length===0){
  books = [
    {
      id: uid(),
      title: 'ドリルと演習シリーズ 基礎数学',
      author: '',
      category: '教科書',
      condition: '良い',
      price: 1463,
      seller: '理学部・工学部 共通',
      contact: '@sample_math',
      image: '',
      description: '理大のリメディアル講座（数学）や基礎数学科目で用いられる定番テキスト。',
      pickup: '図書館前',
      coupon: '',
      createdAt: Date.now()-1000*60*60*24*3,
      sold: false
    },
    {
      id: uid(),
      title: 'アクセスノート 化学基礎 新課程版',
      author: '',
      category: '教科書',
      condition: '良い',
      price: 617,
      seller: '理学部・生命科学部',
      contact: '@sample_chem',
      image: '',
      description: '化学基礎の復習・学習に使われる代表的な入門教科書。',
      pickup: '学生会館',
      coupon: '',
      createdAt: Date.now()-1000*60*60*24*2,
      sold: false
    },
    {
      id: uid(),
      title: 'サイエンスビュー 化学総合資料（四訂版）',
      author: '',
      category: '教科書',
      condition: '良い',
      price: 1463,
      seller: '理学部 化学系',
      contact: '@sample_chem2',
      image: '',
      description: '理大の化学総合で多く利用される資料集。',
      pickup: '図書館前',
      coupon: '',
      createdAt: Date.now()-1000*60*60*24,
      sold: false
    },
    {
      id: uid(),
      title: '物理学基礎 第5版 新装版 Web動画付き',
      author: '',
      category: '教科書',
      condition: '良い',
      price: 2508,
      seller: '工学部 1年',
      contact: '@sample_phys',
      image: '',
      description: '工学部1年の物理学Ⅱで指定される基礎物理の教科書。',
      pickup: 'C1号館前',
      coupon: '',
      createdAt: Date.now()-1000*60*60*6,
      sold: false
    },
    {
      id: uid(),
      title: '専門基礎科目 微分積分',
      author: '',
      category: '教科書',
      condition: '良い',
      price: 2508,
      seller: '理学部・工学部',
      contact: '@sample_calc',
      image: '',
      description: '専門基礎科目（微分積分１）として利用される培風館の教科書。',
      pickup: '図書館前',
      coupon: '',
      createdAt: Date.now()-1000*60*30,
      sold: false
    },
    {
      id: uid(),
      title: '線形代数 例とポイント',
      author: '',
      category: '教科書',
      condition: '良い',
      price: 1672,
      seller: '理学部 応用数学科',
      contact: '@sample_linalg',
      image: '',
      description: '理大の線形代数の授業でよく使われる定番教科書。',
      pickup: '図書館前',
      coupon: '',
      createdAt: Date.now()-1000*60*20,
      sold: false
    },
    {
      id: uid(),
      title: '新・コンピュータ解体新書［第2版］',
      author: '',
      category: '専門書',
      condition: '良い',
      price: 1724,
      seller: '工学部 情報工学科',
      contact: '@sample_ice',
      image: '',
      description: '「情報工学入門」などで定番となっている教科書。',
      pickup: '情報系実験室前',
      coupon: '',
      createdAt: Date.now()-1000*60*10,
      sold: false
    },
    {
      id: uid(),
      title: '現代教育の理論と実践 改訂版',
      author: '',
      category: '教科書',
      condition: '良い',
      price: 2926,
      seller: '教育学部 中等教育学科',
      contact: '@sample_edu',
      image: '',
      description: '教育学部の基礎科目で使われる主要教科書。',
      pickup: '教育学部棟前',
      coupon: '',
      createdAt: Date.now()-1000*60*5,
      sold: false
    },
    {
      id: uid(),
      title: '基礎 有機化学［新訂版］',
      author: '',
      category: '教科書',
      condition: '良い',
      price: 1986,
      seller: '生命科学部',
      contact: '@sample_bio',
      image: '',
      description: '生命科学部・化学系の専門教育科目で利用される有機化学基礎テキスト。',
      pickup: '生命科学部棟ロビー',
      coupon: '',
      createdAt: Date.now()-1000*60*3,
      sold: false
    }
  ];
  save();
}

      if(!localStorage.getItem(pickupKey)){
        pickups = ['図書館前','学生会館','食堂前']; savePickups();
      } else loadPickups();
      loadBiz(); renderTokusho();
      loadCoupons();
      if(!coupons.length){
        coupons = [{code:'WELCOME10', type:'pct', value:10, min:0, cat:[], until:''}];
        saveCoupons();
      }
      try{
        buybackIndex = JSON.parse(localStorage.getItem(buybackIndexKey) || '[]');
        if(!buybackIndex.length){
          buybackIndex = [
            {keyword:'線形代数', msrp: 2500},
            {keyword:'Python', msrp: 3200},
            {keyword:'TOEIC', msrp: 3000},
            {keyword:'統計学入門', msrp: 2800}
          ];
          localStorage.setItem(buybackIndexKey, JSON.stringify(buybackIndex));
        }
      }catch{ buybackIndex=[] }
    }
    function save(){ localStorage.setItem(storeKey, JSON.stringify(books)); }

    function render(){
      ensurePickupOptions();
      const q = $('#q').value.trim().toLowerCase();
      const cat = $('#cat').value; const cond = $('#cond').value; const sort = $('#sort').value; const pickup = $('#pickup').value;
      let data = books.slice();
      if(q){ data = data.filter(b => [b.title,b.author,b.category].join('\n').toLowerCase().includes(q)) }
      if(cat){ data = data.filter(b => b.category===cat) }
      if(cond){ data = data.filter(b => b.condition===cond) }
      if(pickup){ data = data.filter(b => (b.pickup||'')===pickup) }
      if(sort==='price_asc') data.sort((a,b)=>a.price-b.price);
      else if(sort==='price_desc') data.sort((a,b)=>b.price-a.price);
      else data.sort((a,b)=>b.createdAt-a.createdAt);

      const prices = data.map(b=>b.price);
      const sAvg = prices.length? fmtJPY(avg(prices)) : '-';
      const sMed = prices.length? fmtJPY(median(prices)) : '-';
      $('#stats').innerHTML = `掲載 <strong>${data.length}</strong> / 総 ${books.length} 件　<span class="pill">平均 ¥${sAvg}</span> <span class="pill">中央値 ¥${sMed}</span>`;
      $('#kpi').innerHTML = `<span class="pill">受け渡し地点: ${pickups.length} 箇所</span><span class="pill">クーポン: ${coupons.length} 件</span>`;

      const list = $('#list'); list.innerHTML = '';
      $('#empty').hidden = data.length !== 0;
      for(const b of data){
        const card = document.createElement('div');
        card.className = 'card';
        const t = document.createElement('div'); t.className = 'thumb';
        const imgSrc = b.image && b.image.trim() ? b.image : coverFromTitle(b.title, b.author);
        t.innerHTML = `<img src="${imgSrc}" alt="${b.title}">`;
        const body = document.createElement('div'); body.className = 'body';
        const rec = recommendListPrice(b.title, b.condition);
        const market = rec ? `<div class="muted">相場: ¥${fmtJPY(rec.range.low)}〜¥${fmtJPY(rec.range.high)}（推奨 ¥${fmtJPY(rec.rec)}）</div>` : '';

        const coup = applyCoupon(b.coupon, b.price, b.category);
        const priceHtml = coup.applied
          ? `<div class="price">¥${fmtJPY(coup.price)} <del>¥${fmtJPY(b.price)}</del> <span class="badge">Coupon: ${coup.applied.code}</span></div>`
          : `<div class="price">¥${fmtJPY(b.price)}</div>`;

        body.innerHTML = `
          <div class="title">${b.title}</div>
          <div class="muted">${b.author || ''}</div>
          <div class="muted">${b.category}／${b.condition}／受け渡し：${b.pickup||'-'}</div>
          ${priceHtml}
          ${market}
          <div class="muted">
            支払方法：${b.payMethod || '未指定'}
            ${
              b.payLink
                ? ` ／ <a href="${b.payLink}" target="_blank" rel="noopener noreferrer">決済リンクを開く</a>`
                : ''
            }
          </div>
          ${b.description?`<div class="muted">${b.description}</div>`:''}
          <div class="muted">出品者：${b.seller || '-'}　連絡：${b.contact || '-'}</div>
          <div class="actions">
            <span class="badge">ID: ${b.id.slice(0,6)}</span>
            ${b.sold?'<span class="badge sold">SOLD</span>':''}
            ${b.paid?'<span class="badge">支払い済み</span>':''}
            <button class="btn ghost" data-edit="1">編集</button>
            <button class="btn warn" data-sold="1">${b.sold?'販売可能に戻す':'SOLDにする'}</button>
            <button class="btn ghost" data-paid="1">${b.paid ? '未払いに戻す' : '支払い済みにする'}</button>
            <button class="btn ghost" data-buyback="1" title="この書籍名で買取目安を表示">買取目安</button>
          </div>
        `;
        card.appendChild(t); card.appendChild(body);
        list.appendChild(card);
        $('[data-edit]', body).onclick = ()=> openEdit(b.id);
        $('[data-sold]', body).onclick = ()=> toggleSold(b.id);
        const paidBtn = $('[data-paid]', body);
        if(paidBtn) paidBtn.onclick = ()=> togglePaid(b.id);
        $('[data-buyback]', body).onclick = ()=> openBuybackPrefill(b.title, b.condition);
      }
    }

    function openCreate(){ editingId = null; $('#modalTitle').textContent='出品を作成'; $('#delBtn').style.display='none'; fillForm({}); $('#suggestInfo').innerHTML=''; $('#modal').showModal(); }
    function openEdit(id){ editingId = id; const b = books.find(x=>x.id===id); $('#modalTitle').textContent='出品を編集'; $('#delBtn').style.display='inline-flex'; fillForm(b); $('#suggestInfo').innerHTML=''; $('#modal').showModal(); }
    function fillForm(b){
      $('#f_title').value=b.title||''; $('#f_author').value=b.author||''; $('#f_cat').value=b.category||'教科書'; $('#f_cond').value=b.condition||'良い';
      $('#f_price').value=b.price||''; $('#f_img').value=b.image||''; $('#f_seller').value=b.seller||''; $('#f_contact').value=b.contact||'';
      $('#f_desc').value=b.description||''; $('#f_pickup').value=b.pickup||''; $('#f_coupon').value=b.coupon||'';
      $('#f_payMethod').value=b.payMethod||''; $('#f_payLink').value=b.payLink||'';
    }
    function readForm(){
      return {
        title: $('#f_title').value.trim(),
        author: $('#f_author').value.trim(),
        category: $('#f_cat').value,
        condition: $('#f_cond').value,
        price: parseInt($('#f_price').value||'0'),
        image: $('#f_img').value.trim(),
        seller: $('#f_seller').value.trim(),
        contact: $('#f_contact').value.trim(),
        description: $('#f_desc').value.trim(),
        pickup: $('#f_pickup').value.trim(),
        coupon: $('#f_coupon').value.trim(),
        payMethod: $('#f_payMethod').value,
        payLink: $('#f_payLink').value.trim()
      }
    }
    function onSave(e){ e.preventDefault(); const v = readForm(); if(!v.title||!v.price){alert('書名と価格は必須です'); return}
      if(!v.image){ v.image = coverFromTitle(v.title, v.author); }
      if(v.pickup && !pickups.includes(v.pickup)){ pickups.push(v.pickup); savePickups(); }
      if(editingId){ const i = books.findIndex(x=>x.id===editingId); books[i] = {...books[i], ...v}; }
      else{ books.unshift({id:uid(), createdAt:Date.now(), sold:false, paid:false, ...v}); }
      save(); render(); $('#modal').close();
    }
    function onDelete(e){ e.preventDefault(); if(!editingId) return; if(!confirm('この出品を削除しますか？')) return; books = books.filter(x=>x.id!==editingId); save(); render(); $('#modal').close(); }
    function toggleSold(id){ const b = books.find(x=>x.id===id); b.sold=!b.sold; save(); render(); }
    function togglePaid(id){ const b = books.find(x=>x.id===id); if(!b) return; b.paid = !b.paid; save(); render(); }
    $('#genCoverBtn').onclick = ()=>{ const title = $('#f_title').value || 'BOOK'; const author = $('#f_author').value || ''; $('#f_img').value = coverFromTitle(title, author); };
    $('#suggestBtn').onclick = ()=>{
      const title = $('#f_title').value; const cond = $('#f_cond').value; const rec = recommendListPrice(title, cond); const info = $('#suggestInfo');
      if(!rec){ info.innerHTML = '相場データが不足しています（一覧に近い書籍を増やすか、参考定価データを読み込んでください）。'; return; }
      $('#f_price').value = Math.round(rec.rec);
      const src = rec.source==='listing_median' ? `掲載${rec.count}件の中央値` : '参考定価';
      info.innerHTML = `基準：${src} = ¥${fmtJPY(rec.base)} ／ 推奨：<strong>¥${fmtJPY(rec.rec)}</strong>（推奨レンジ ¥${fmtJPY(rec.range.low)}〜¥${fmtJPY(rec.range.high)}、買取目安 ¥${fmtJPY(rec.buybackMid)} 程度）`;
    };

    function findListingBase(query){
      const q = (query||'').trim().toLowerCase(); if(!q) return null;
      const matches = books.filter(b => [b.title, b.author].join('\n').toLowerCase().includes(q));
      if(matches.length){ return { base: avg(matches.map(m=>m.price)), count: matches.length, source: 'listing' }; }
      const hit = buybackIndex.find(x => x.keyword && q.includes(String(x.keyword).toLowerCase()) ); if(hit){ return { base: hit.msrp, count: 0, source: 'msrp' }; }
      return null;
    }
    function estimateBuybackOld(base, condition){ const k = condFactorBuyback[condition] ?? condFactorBuyback['良い']; const est = base * k; return { mid: est, low: est*0.85, high: est*1.15 }; }
    function openBuyback(){ $('#bb_query').value = ''; $('#bb_cond').value = '良い'; $('#bb_result').innerHTML = ''; $('#buyback').showModal(); }
    function openBuybackPrefill(title, condition='良い'){ $('#bb_query').value = title || ''; $('#bb_cond').value = condition || '良い'; $('#bb_result').innerHTML = ''; $('#buyback').showModal(); calcBuyback(); }
    function calcBuyback(){
      const q = $('#bb_query').value; const c = $('#bb_cond').value; const res = findListingBase(q); const result = $('#bb_result');
      if(!res){ result.innerHTML = '該当データが見つかりませんでした。<br>・同名の掲載データを追加するか、<br>・「参考定価データ(JSON)」を読み込んで再試行してください。'; return; }
      const range = estimateBuybackOld(res.base, c);
      const srcLabel = res.source==='listing' ? `掲載${res.count}件の平均価格` : '参考定価（読み込みデータ）';
      result.innerHTML = `<div>基準：<strong>${srcLabel}</strong> = ¥${fmtJPY(res.base)}</div><div>状態係数（${c}）= ${((condFactorBuyback[c]||0)*100).toFixed(0)}%</div><div style="margin-top:6px;">目安の買取価格：<strong>¥${fmtJPY(range.mid)}</strong>（レンジ：¥${fmtJPY(range.low)}〜¥${fmtJPY(range.high)}）</div>`;
    }
    function importBuybackIndex(file){
      const r = new FileReader();
      r.onload = ()=>{ try{ const data = JSON.parse(r.result); if(Array.isArray(data)){ buybackIndex = data.filter(x => x && typeof x.keyword === 'string' && Number.isFinite(Number(x.msrp))); localStorage.setItem(buybackIndexKey, JSON.stringify(buybackIndex)); alert('参考定価データを読み込みました'); } else { alert('JSONの形式が正しくありません（配列ではありません）'); } }catch{ alert('JSONの解析に失敗しました'); } };
      r.readAsText(file);
    }

    function renderCoupons(){
      const el = $('#cp_list');
      if(!coupons.length){ el.innerHTML='（登録なし）'; return; }
      el.innerHTML = coupons.map(c=>{
        const cat = (c.cat||[]).join(' , ') || '全体';
        const until = c.until || '—';
        const v = c.type==='pct' ? (c.value+'%OFF') : ('¥'+fmtJPY(c.value)+' OFF');
        return `<div class="pill">${c.code} | ${v} | 最小¥${fmtJPY(c.min||0)} | カテゴリ:${cat} | 期限:${until} <button data-del="${c.code}" class="btn ghost" style="padding:2px 8px;margin-left:6px">削除</button></div>`;
      }).join('');
      $$('[data-del]','#coupon').forEach(b=> b.onclick = ()=>{ coupons = coupons.filter(x=>x.code!==b.getAttribute('data-del')); saveCoupons(); renderCoupons(); render(); });
    }

    function fillBizForm(){ $('#bz_name').value=biz.name||''; $('#bz_owner').value=biz.owner||''; $('#bz_addr').value=biz.addr||''; $('#bz_contact').value=biz.contact||''; $('#bz_url').value=biz.url||''; $('#bz_kobutsu').value=biz.kobutsu||''; renderTokusho(); }

    function exportData(){ const blob = new Blob([JSON.stringify({books,coupons,pickups,biz},null,2)], {type:'application/json'}); const a = Object.assign(document.createElement('a'), {href:URL.createObjectURL(blob), download:'crb-data.json'}); a.click(); URL.revokeObjectURL(a.href) }
    function importData(file){ const r = new FileReader(); r.onload = ()=>{ try{ const data = JSON.parse(r.result); if(data.books){ books = data.books } if(data.coupons){ coupons = data.coupons } if(data.pickups){ pickups = data.pickups } if(data.biz){ biz = data.biz } save(); saveCoupons(); savePickups(); saveBiz(); ensurePickupOptions(); render(); alert('読み込み完了') }catch{ alert('JSONの形式が正しくありません') } }; r.readAsText(file) }

    $('#addBtn').onclick = openCreate;
    $('#saveBtn').onclick = onSave;
    $('#delBtn').onclick = onDelete;
    $('#exportBtn').onclick = exportData;
    $('#importFile').onchange = e=>{ const f = e.target.files[0]; if(f) importData(f) };
    ['q','cat','cond','sort','pickup'].forEach(id=>{ document.getElementById(id).addEventListener('input', render); document.getElementById(id).addEventListener('change', render) });
    $('#buybackBtn').onclick = ()=> $('#buyback').showModal();
    $('#bb_calc').onclick = ()=> calcBuyback();
    $('#buybackFile').onchange = e=>{ const f = e.target.files[0]; if(f) importBuybackIndex(f); };
    $('#couponBtn').onclick = ()=>{ renderCoupons(); $('#coupon').showModal(); };
    $('#cp_add').onclick = ()=>{
      const c = {
        code: $('#cp_code').value.trim(),
        type: $('#cp_type').value,
        value: parseInt($('#cp_value').value||'0'),
        min: parseInt($('#cp_min').value||'0'),
        cat: ($('#cp_cat').value||'').split(',').map(s=>s.trim()).filter(Boolean),
        until: $('#cp_until').value
      };
      if(!c.code||!c.value){ alert('コードと値引値を入力'); return; }
      const i = coupons.findIndex(x=>x.code===c.code);
      if(i>=0) coupons[i]=c; else coupons.push(c);
      saveCoupons(); renderCoupons(); render();
    };
    $('#cp_clear').onclick = ()=>{ if(confirm('全クーポンを削除しますか？')){ coupons=[]; saveCoupons(); renderCoupons(); render(); } };

    $('#openTos').onclick = ()=> $('#tos').showModal();
    $('#openTos2').onclick = ()=> $('#tos').showModal();
    $('#tosAgreeBtn').onclick = ()=>{ if($('#tosAgreeChk').checked){ localStorage.setItem(tosKey,'1') } };

    $('#bizBtn').onclick = ()=>{ fillBizForm(); $('#biz').showModal(); };
    $('#openBiz').onclick = ()=>{ fillBizForm(); $('#biz').showModal(); };
    $('#bz_save').onclick = (e)=>{ e.preventDefault(); biz = {name:$('#bz_name').value, owner:$('#bz_owner').value, addr:$('#bz_addr').value, contact:$('#bz_contact').value, url:$('#bz_url').value, kobutsu:$('#bz_kobutsu').value}; saveBiz(); renderTokusho(); alert('保存しました'); };
    $('#bz_clear').onclick = (e)=>{ e.preventDefault(); if(confirm('事業者情報を消去しますか？')){ biz={}; saveBiz(); renderTokusho(); } };

    (function init(){
      load(); render(); loadCoupons(); ensurePickupOptions();
      try{ if(localStorage.getItem(tosKey)!=='1'){ $('#tos').showModal(); } }catch{}
    })();
  </script>
</body>
</html>